rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection - users can only read/write their own document
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Links collection - users can only manage their own links
    match /links/{linkId} {
      // Read: Allow public read for active links (for redirects), or authenticated users can read their own links
      allow read: if resource.data.isActive == true || (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      // Create: User must be authenticated and the userId must match their auth uid
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'title', 'destinationUrl', 'slug', 'createdAt', 'updatedAt', 'clicks', 'isActive'])
        && request.resource.data.clicks is int
        && request.resource.data.isActive is bool;
      
      // Update: Only owner can update, and userId cannot be changed
      allow update: if isAuthenticated() 
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.updatedAt is timestamp;
      
      // Delete: Only owner can delete
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // App settings (global)
    // Public read so 404 redirect works for anonymous users
    // Writes allowed for authenticated users (adjust to restrict to admins if needed)
    match /settings/{docId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Clicks collection - for tracking link clicks
    match /clicks/{clickId} {
      // Read: Users can only read clicks for their own links, or allow public read for analytics
      allow read: if isAuthenticated() 
        && exists(/databases/$(database)/documents/links/$(resource.data.linkId))
        && get(/databases/$(database)/documents/links/$(resource.data.linkId)).data.userId == request.auth.uid;
      
      // Create: Anyone can create clicks (for tracking), but with validation
      allow create: if request.resource.data.keys().hasAll(['linkId', 'timestamp'])
        && request.resource.data.linkId is string
        && request.resource.data.timestamp is timestamp
        && exists(/databases/$(database)/documents/links/$(request.resource.data.linkId));
      
      // Update: Allow users to update location data for their own link clicks
      // Check that user owns the link and only location fields are being updated
      allow update: if isAuthenticated()
        && resource.data.linkId is string
        && exists(/databases/$(database)/documents/links/$(resource.data.linkId))
        && get(/databases/$(database)/documents/links/$(resource.data.linkId)).data.userId == request.auth.uid
        // Ensure critical fields don't change
        && request.resource.data.linkId == resource.data.linkId
        && request.resource.data.timestamp == resource.data.timestamp
        // Allow updating only location fields (check that all changed keys are location fields)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['country', 'city', 'region', 'countryCode', 'timezone']);
    }
  }
}

