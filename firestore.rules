rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection - users can only read/write their own document
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Links collection - users can only manage their own links
    match /links/{linkId} {
      // Read: Allow public read for active links (for redirects), or authenticated users can read their own links
      allow read: if resource.data.isActive == true || (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      // Create: User must be authenticated and the userId must match their auth uid
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'title', 'destinationUrl', 'slug', 'createdAt', 'updatedAt', 'clicks', 'isActive'])
        && request.resource.data.clicks is int
        && request.resource.data.isActive is bool;
      
      // Update: Only owner can update, and userId cannot be changed
      allow update: if isAuthenticated() 
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.updatedAt is timestamp;
      
      // Delete: Only owner can delete
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // App settings (global)
    // Public read so 404 redirect works for anonymous users
    // Writes allowed for authenticated users (adjust to restrict to admins if needed)
    match /settings/{docId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Clicks collection - for tracking link clicks
    match /clicks/{clickId} {
      // Read: Users can only read clicks for their own links, or allow public read for analytics
      allow read: if isAuthenticated() 
        && exists(/databases/$(database)/documents/links/$(resource.data.linkId))
        && get(/databases/$(database)/documents/links/$(resource.data.linkId)).data.userId == request.auth.uid;
      
      // Create: Anyone can create clicks (for tracking), but with validation
      allow create: if request.resource.data.keys().hasAll(['linkId', 'timestamp'])
        && request.resource.data.linkId is string
        && request.resource.data.timestamp is timestamp
        && exists(/databases/$(database)/documents/links/$(request.resource.data.linkId));
      
      // Update: Allow users to update location data for their own link clicks
      // Check that user owns the link and only location fields are being updated
      allow update: if isAuthenticated()
        && resource.data.linkId is string
        && exists(/databases/$(database)/documents/links/$(resource.data.linkId))
        && get(/databases/$(database)/documents/links/$(resource.data.linkId)).data.userId == request.auth.uid
        // Ensure critical fields don't change
        && request.resource.data.linkId == resource.data.linkId
        && request.resource.data.timestamp == resource.data.timestamp
        // Allow updating only location fields (check that all changed keys are location fields)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['country', 'city', 'region', 'countryCode', 'timezone']);
    }
    
    // Releases collection - users can only manage their own releases
    match /releases/{releaseId} {
      // Read: Allow public read for active releases (for display), or authenticated users can read their own releases
      allow read: if resource.data.isActive == true || (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      // Create: User must be authenticated and the userId must match their auth uid
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'artistName', 'releaseName', 'artworkUrl', 'releaseType', 'slug', 'createdAt', 'updatedAt', 'views', 'isActive'])
        && request.resource.data.views is int
        && request.resource.data.isActive is bool;
      
      // Update: Only owner can update, and userId cannot be changed
      allow update: if isAuthenticated() 
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.updatedAt is timestamp;
      
      // Delete: Only owner can delete
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ReleaseClicks collection - for tracking release views and button clicks
    match /releaseClicks/{clickId} {
      // Read: Users can only read clicks for their own releases
      allow read: if isAuthenticated() 
        && exists(/databases/$(database)/documents/releases/$(resource.data.releaseId))
        && get(/databases/$(database)/documents/releases/$(resource.data.releaseId)).data.userId == request.auth.uid;
      
      // Create: Anyone can create release clicks (for tracking), but with validation
      allow create: if request.resource.data.keys().hasAll(['releaseId', 'timestamp', 'clickType'])
        && request.resource.data.releaseId is string
        && request.resource.data.timestamp is timestamp
        && request.resource.data.clickType is string
        && exists(/databases/$(database)/documents/releases/$(request.resource.data.releaseId));
      
      // Update: Allow users to update location data for their own release clicks
      allow update: if isAuthenticated()
        && resource.data.releaseId is string
        && exists(/databases/$(database)/documents/releases/$(resource.data.releaseId))
        && get(/databases/$(database)/documents/releases/$(resource.data.releaseId)).data.userId == request.auth.uid
        && request.resource.data.releaseId == resource.data.releaseId
        && request.resource.data.timestamp == resource.data.timestamp
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['country', 'city', 'region', 'countryCode', 'timezone']);
    }
    
    // Artists collection - users can only manage their own artists
    match /artists/{artistId} {
      // Read: Allow public read for artist bio pages, or authenticated users can read their own artists
      allow read: if true; // Public read for bio pages
      
      // Create: User must be authenticated and the userId must match their auth uid
      // Similar to releases - check required fields exist but don't enforce strict types
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'name', 'slug', 'createdAt', 'updatedAt'])
        && request.resource.data.name is string
        && request.resource.data.slug is string;
      
      // Update: Only owner can update, and userId cannot be changed
      allow update: if isAuthenticated() 
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId;
      
      // Delete: Only owner can delete
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Newsletter collection - for storing newsletter subscriptions
    // Structure: newsletter/{artistName}/emails/{emailId}
    match /newsletter/{artistName}/emails/{emailId} {
      // Read: Only the artist owner can read emails
      allow read: if isAuthenticated() 
        && exists(/databases/$(database)/documents/artists/$(resource.data.artistId))
        && get(/databases/$(database)/documents/artists/$(resource.data.artistId)).data.userId == request.auth.uid;
      
      // Create: Anyone can subscribe to newsletter (public)
      allow create: if request.resource.data.keys().hasAll(['email', 'subscribedAt', 'artistName', 'artistId'])
        && request.resource.data.email is string
        && request.resource.data.subscribedAt is timestamp
        && request.resource.data.artistName is string
        && request.resource.data.artistId is string;
      
      // Update/Delete: Only artist owner can manage subscriptions
      allow update, delete: if isAuthenticated()
        && resource.data.artistId is string
        && exists(/databases/$(database)/documents/artists/$(resource.data.artistId))
        && get(/databases/$(database)/documents/artists/$(resource.data.artistId)).data.userId == request.auth.uid;
    }
  }
}

